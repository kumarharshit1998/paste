[Authorize]
[HttpGet]
public IActionResult BulkImport(string stage)
{
    if (stage == "SelectSheet")
    {
        if (TempData["SheetNames"] != null)
        {
            ViewBag.SheetNames = JsonConvert.DeserializeObject<List<string>>(TempData["SheetNames"].ToString());
            ViewBag.Stage = "SelectSheet";
        }
    }
    else if (stage == "MapColumns")
    {
        ViewBag.SelectedSheet = TempData["SelectedSheet"];
        ViewBag.Stage = "MapColumns";
    }

    return View();
}

[Authorize]
[HttpPost]
public IActionResult BulkImport(IFormFile ExcelFile, string stage, string SelectedSheet)
{
    if (stage == "upload")
    {
        if (ExcelFile == null || ExcelFile.Length == 0)
        {
            ViewBag.Error = "Please select a valid Excel file.";
            return View();
        }

        ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
        using var stream = new MemoryStream();
        ExcelFile.CopyTo(stream);
        using var package = new ExcelPackage(stream);

        var sheetNames = package.Workbook.Worksheets.Select(ws => ws.Name).ToList();

        TempData["ExcelFileBase64"] = Convert.ToBase64String(stream.ToArray());
        TempData["SheetNames"] = JsonConvert.SerializeObject(sheetNames);

        return RedirectToAction("BulkImport", new { stage = "SelectSheet" });
    }

    if (stage == "sheetSelected")
    {
        TempData["SelectedSheet"] = SelectedSheet;
        return RedirectToAction("BulkImport", new { stage = "MapColumns" });
    }

    return View();
}
















