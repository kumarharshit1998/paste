using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using OfficeOpenXml;
using System.Text;

namespace YourNamespace.Controllers
{
    [Authorize]
    public class AutoFillController : Controller
    {
        [HttpGet]
        public IActionResult BulkImport()
        {
            ViewData["Title"] = "Excel Import";
            return View();
        }

        [HttpPost]
        public IActionResult BulkImport(IFormFile ExcelFile, string stage, string SelectedSheet)
        {
            if (stage == "upload")
            {
                if (ExcelFile == null || ExcelFile.Length == 0)
                {
                    ViewBag.Error = "Please select a valid Excel file.";
                    return View();
                }

                ExcelPackage.LicenseContext = LicenseContext.NonCommercial;

                using var stream = new MemoryStream();
                ExcelFile.CopyTo(stream);

                using var package = new ExcelPackage(stream);
                var sheetNames = package.Workbook.Worksheets.Select(ws => ws.Name).ToList();

                TempData["ExcelFileBase64"] = Convert.ToBase64String(stream.ToArray());
                TempData.Keep("ExcelFileBase64");

                ViewBag.SheetNames = sheetNames;
                ViewBag.Stage = "SelectSheet";
                return View();
            }

            if (stage == "sheetSelected")
            {
                string base64Excel = TempData["ExcelFileBase64"] as string;
                if (string.IsNullOrEmpty(base64Excel))
                {
                    ViewBag.Error = "Excel file data is missing.";
                    return View();
                }

                TempData.Keep("ExcelFileBase64");

                var excelBytes = Convert.FromBase64String(base64Excel);
                using var stream = new MemoryStream(excelBytes);

                ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
                using var package = new ExcelPackage(stream);

                var worksheet = package.Workbook.Worksheets[SelectedSheet];
                if (worksheet == null)
                {
                    ViewBag.Error = $"Sheet '{SelectedSheet}' not found.";
                    return View();
                }

                // Read first row (column headers)
                var columns = new List<string>();
                for (int col = worksheet.Dimension.Start.Column; col <= worksheet.Dimension.End.Column; col++)
                {
                    columns.Add(worksheet.Cells[1, col].Text);
                }

                ViewBag.SelectedSheet = SelectedSheet;
                ViewBag.Columns = columns;
                ViewBag.Stage = "MapColumns";
                return View();
            }

            return View();
        }
    }
}


















@{
    ViewData["Title"] = "Excel Import";
    Layout = "_Layout";
    var stage = ViewBag.Stage as string;
    var sheetNames = ViewBag.SheetNames as List<string>;
    var columns = ViewBag.Columns as List<string>;
}

<link rel="stylesheet" type="text/css" href="~/css/site.css" />

@if (ViewBag.Error != null)
{
    <div class="alert alert-danger">@ViewBag.Error</div>
}

@if (string.IsNullOrEmpty(stage))
{
    <form asp-action="BulkImport" asp-controller="AutoFill" method="post" enctype="multipart/form-data">
        <input type="hidden" name="stage" value="upload" />
        <table class="clsDarkBorder" width="1000px">
            <tr>
                <td colspan="2" class="clsFormHeader" style="text-align:center;">Bulk Auto Fill</td>
            </tr>
            <tr>
                <td colspan="2" style="text-align:center;">
                    Upload File: <input type="file" name="ExcelFile" required />
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align:center;">
                    <label>To upload file, click 'Upload Spreadsheet'</label>
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align:center;">
                    <button type="submit" class="btn btn-primary">Upload Spreadsheet</button>
                </td>
            </tr>
        </table>
    </form>
}
else if (stage == "SelectSheet" && sheetNames != null)
{
    <form asp-action="BulkImport" asp-controller="AutoFill" method="post">
        <input type="hidden" name="stage" value="sheetSelected" />
        <table class="clsDarkBorder" width="1000px" style="margin-top: 20px;">
            <tr>
                <td colspan="2" class="clsFormHeader">SHAW Autofill Sheet Options</td>
            </tr>
            <tr>
                <td style="width: 200px;">Choose Sheet Tab:</td>
                <td>
                    <select name="SelectedSheet" class="form-select" required>
                        @foreach (var sheet in sheetNames)
                        {
                            <option value="@sheet">@sheet</option>
                        }
                    </select>
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: center;">
                    <button type="submit" class="btn btn-success">Next</button>
                </td>
            </tr>
        </table>
    </form>
}
else if (stage == "MapColumns" && columns != null)
{
    <form asp-action="BulkImport" asp-controller="AutoFill" method="post">
        <table class="clsDarkBorder" width="1000px" style="margin-top: 20px;">
            <tr>
                <td colspan="2" class="clsFormHeader">Map Columns</td>
            </tr>
            @foreach (var col in columns)
            {
                <tr>
                    <td>@col</td>
                    <td><input type="text" name="Mapped_@col" /></td>
                </tr>
            }
            <tr>
                <td colspan="2" style="text-align:center;">
                    <button type="submit" class="btn btn-primary">Finish Mapping</button>
                </td>
            </tr>
        </table>
    </form>
}
