@model List<AutoFillReportRowModel>
@{
    ViewData["Title"] = "Excel Import";
    Layout = "_Layout";

    var stage = ViewBag.Stage as string;
    var sheetNames = ViewBag.SheetNames as List<string>;
}

<link rel="stylesheet" type="text/css" href="~/css/site.css" />

@if (string.IsNullOrEmpty(stage))
{
    <form asp-action="BulkImport" asp-controller="AutoFill" method="post" enctype="multipart/form-data">
        <input type="hidden" name="stage" value="upload" />
        <table id="BAF" width="1000px" class="clsDarkBorder">
            <tr>
                <td colspan="2" class="clsFormHeader" style="text-align:center;">Bulk Auto Fill</td>
            </tr>
            <tr>
                <td colspan="2" style="text-align:center;">
                    Upload File: <input type="file" name="ExcelFile" required />
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align:center;">
                    <label>To upload file, click 'Upload Spreadsheet'</label>
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align:center;">
                    <button type="submit" class="btn btn-primary">Upload Spreadsheet</button>
                </td>
            </tr>
        </table>
    </form>
}

@if (stage == "SelectSheet" && sheetNames != null)
{
    <form asp-action="BulkImport" asp-controller="AutoFill" method="post">
        <input type="hidden" name="stage" value="sheetSelected" />

        <table width="1000px" class="clsDarkBorder" style="margin-top:20px;">
            <tr>
                <td colspan="2" class="clsFormHeader" style="text-align:left;">SHAW Autofill Sheet Options</td>
            </tr>
            <tr>
                <td style="width: 200px;">Choose Sheet Tab:</td>
                <td>
                    <select name="SelectedSheet" class="form-select" required>
                        @foreach (var sheet in sheetNames)
                        {
                            <option value="@sheet">@sheet</option>
                        }
                    </select>
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align:center;">
                    <button type="submit" class="btn btn-success">Next</button>
                </td>
            </tr>
        </table>
    </form>
}















[HttpPost]
public IActionResult BulkImport(IFormFile ExcelFile, string stage, string SelectedSheet)
{
    if (stage == "upload")
    {
        if (ExcelFile == null || ExcelFile.Length == 0)
        {
            ViewBag.Error = "Please select a valid Excel file.";
            return View();
        }

        using var stream = new MemoryStream();
        ExcelFile.CopyTo(stream);
        using var package = new ExcelPackage(stream);
        var sheetNames = package.Workbook.Worksheets.Select(ws => ws.Name).ToList();

        TempData["ExcelFileBase64"] = Convert.ToBase64String(stream.ToArray());
        ViewBag.SheetNames = sheetNames;
        ViewBag.Stage = "SelectSheet";

        return View();
    }

    if (stage == "sheetSelected")
    {
        // Use SelectedSheet to prepare the next screen logic
        ViewBag.SelectedSheet = SelectedSheet;
        ViewBag.Stage = "MapColumns"; // will use this for the next step
        return View();
    }

    return View();
}
